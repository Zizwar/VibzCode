<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VibZcode</title>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4/dist/full.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github-dark.min.css">
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="/js/utils.js"></script>
  <script src="/js/upload.js"></script>
  <script src="/js/filetree.js"></script>
  <script src="/js/chat.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/app.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    [x-cloak] { display: none !important; }
    .scrollbar-thin::-webkit-scrollbar { width: 4px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: oklch(var(--bc) / 0.15); border-radius: 4px; }
    .fade-in { animation: fadeIn .2s ease-out; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(4px) } to { opacity:1; transform:translateY(0) } }
    .chat-md h1,.chat-md h2,.chat-md h3 { font-weight:700; margin:.5em 0 }
    .chat-md h1 { font-size:1.2em } .chat-md h2 { font-size:1.1em } .chat-md h3 { font-size:1.05em }
    .chat-md p { margin:.4em 0 }
    .chat-md pre { background:oklch(var(--b3)); padding:.7em; border-radius:.5em; overflow-x:auto; margin:.5em 0; font-size:.82em }
    .chat-md code { font-size:.88em }
    .chat-md :not(pre)>code { background:oklch(var(--b3)); padding:.1em .3em; border-radius:.25em }
    .chat-md ul,.chat-md ol { padding-left:1.4em; margin:.4em 0 }
    .chat-md li { margin:.2em 0 }
    .chat-md blockquote { border-left:3px solid oklch(var(--p)); padding-left:.8em; opacity:.85; margin:.5em 0 }
    .chat-md a { color:oklch(var(--p)); text-decoration:underline }
    .chat-md table { width:100%; border-collapse:collapse; margin:.5em 0 }
    .chat-md th,.chat-md td { border:1px solid oklch(var(--bc) / 0.1); padding:.4em .6em; text-align:left }
    .chat-md th { font-weight:600; background:oklch(var(--b2)) }
    .chat-md hr { border-color:oklch(var(--bc) / 0.1); margin:.8em 0 }
  </style>
</head>
<body class="min-h-screen bg-base-100" x-data="vibzcode">

  <!-- DRAWER LAYOUT -->
  <div class="drawer lg:drawer-open">
    <input id="sidebar" type="checkbox" class="drawer-toggle">

    <!-- MAIN CONTENT -->
    <div class="drawer-content flex flex-col min-h-screen">

      <!-- NAVBAR -->
      <nav class="navbar bg-base-200/80 backdrop-blur border-b border-base-300 sticky top-0 z-30 px-3 min-h-12">
        <div class="flex-none lg:hidden">
          <label for="sidebar" class="btn btn-ghost btn-sm btn-square">
            <i class="fas fa-bars"></i>
          </label>
        </div>
        <div class="flex-1 gap-2">
          <span class="text-lg font-bold tracking-tight"><span class="text-primary">Vibz</span>code</span>
          <div class="badge badge-ghost badge-sm truncate max-w-40" x-show="currentFilename" x-text="currentFilename" x-cloak></div>
        </div>
        <div class="flex-none flex items-center gap-1.5">
          <div class="badge badge-outline badge-sm gap-1 font-mono" x-show="tokenCount > 0" x-cloak>
            <i class="fas fa-coins text-[10px]"></i>
            <span x-text="'~' + formatTokens(tokenCount)"></span>
          </div>
          <select class="select select-bordered select-xs w-36 hidden sm:inline-flex" x-model="selectedModel">
            <template x-for="m in enabledModels()" :key="m.id">
              <option :value="m.id" x-text="m.name"></option>
            </template>
          </select>
          <label class="swap swap-rotate btn btn-ghost btn-sm btn-circle">
            <input type="checkbox" :checked="darkMode" @change="toggleDarkMode()">
            <i class="fas fa-sun swap-off text-sm"></i>
            <i class="fas fa-moon swap-on text-sm"></i>
          </label>
          <button class="btn btn-ghost btn-sm btn-circle" @click="showSettings = true; fetchEnvConfig()">
            <i class="fas fa-cog text-sm"></i>
          </button>
        </div>
      </nav>

      <!-- MAIN AREA -->
      <main class="flex-1 flex flex-col p-3 sm:p-4 gap-3 max-w-5xl mx-auto w-full">

        <!-- TABS -->
        <div role="tablist" class="tabs tabs-boxed bg-base-200 p-1 self-start">
          <a role="tab" class="tab tab-sm gap-1.5" :class="{'tab-active': currentTab === 'prompt'}" @click="currentTab = 'prompt'">
            <i class="fas fa-terminal text-xs"></i> <span class="hidden sm:inline">Prompt</span>
          </a>
          <a role="tab" class="tab tab-sm gap-1.5" :class="{'tab-active': currentTab === 'chat'}" @click="currentTab = 'chat'">
            <i class="fas fa-comments text-xs"></i> <span class="hidden sm:inline">Chat</span>
            <div class="badge badge-xs badge-primary" x-show="chatMessages.length" x-text="chatMessages.length" x-cloak></div>
          </a>
          <a role="tab" class="tab tab-sm gap-1.5" :class="{'tab-active': currentTab === 'output'}" @click="currentTab = 'output'">
            <i class="fas fa-code text-xs"></i> <span class="hidden sm:inline">Output</span>
          </a>
        </div>

        <!-- PROMPT TAB -->
        <div x-show="currentTab === 'prompt'" x-cloak class="flex flex-col gap-3 flex-1">
          <div class="flex gap-2 flex-wrap">
            <select class="select select-bordered select-sm flex-1 min-w-[160px]" x-model="selectedTemplate" @change="applyTemplate()">
              <option value="">Select template...</option>
              <template x-for="t in promptTemplates" :key="t.name">
                <option :value="t.name" x-text="t.name"></option>
              </template>
            </select>
            <select class="select select-bordered select-sm sm:hidden flex-1 min-w-[140px]" x-model="selectedModel">
              <template x-for="m in enabledModels()" :key="m.id">
                <option :value="m.id" x-text="m.name"></option>
              </template>
            </select>
          </div>

          <textarea class="textarea textarea-bordered flex-1 min-h-[180px] font-mono text-sm leading-relaxed resize-y"
            x-model="mainPrompt"
            @input="updateTokenCount(); saveSession()"
            placeholder="Write your prompt here... Selected files will be appended when extracted."></textarea>

          <!-- Quick Actions -->
          <div class="flex flex-wrap gap-1.5">
            <button class="btn btn-xs btn-outline gap-1" @click="runQuickAction('explain')" :disabled="selectedFiles.length===0">
              <i class="fas fa-lightbulb"></i> Explain
            </button>
            <button class="btn btn-xs btn-outline gap-1" @click="runQuickAction('bugs')" :disabled="selectedFiles.length===0">
              <i class="fas fa-bug"></i> Bugs
            </button>
            <button class="btn btn-xs btn-outline gap-1" @click="runQuickAction('improve')" :disabled="selectedFiles.length===0">
              <i class="fas fa-wand-magic-sparkles"></i> Improve
            </button>
            <button class="btn btn-xs btn-outline gap-1" @click="runQuickAction('tests')" :disabled="selectedFiles.length===0">
              <i class="fas fa-flask"></i> Tests
            </button>
            <button class="btn btn-xs btn-outline gap-1" @click="runQuickAction('docs')" :disabled="selectedFiles.length===0">
              <i class="fas fa-book"></i> Docs
            </button>
            <button class="btn btn-xs btn-outline gap-1" @click="runQuickAction('refactor')" :disabled="selectedFiles.length===0">
              <i class="fas fa-recycle"></i> Refactor
            </button>
          </div>

          <!-- Extract bar -->
          <div class="card bg-base-200 p-3">
            <div class="flex flex-wrap gap-x-4 gap-y-2 items-center">
              <label class="flex items-center gap-1.5 cursor-pointer">
                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary" x-model="includeFileStructure">
                <span class="text-xs">Structure</span>
              </label>
              <label class="flex items-center gap-1.5 cursor-pointer">
                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary" x-model="excludeMediaFiles">
                <span class="text-xs">No media</span>
              </label>
              <label class="flex items-center gap-1.5 cursor-pointer">
                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary" x-model="summarizeCode">
                <span class="text-xs">Summarize</span>
              </label>
              <label class="flex items-center gap-1.5 cursor-pointer">
                <input type="checkbox" class="checkbox checkbox-xs checkbox-primary" x-model="enableCache">
                <span class="text-xs">Cache</span>
              </label>
              <div class="flex-1"></div>
              <div class="badge badge-ghost badge-sm" x-show="selectedFiles.length" x-cloak>
                <span x-text="selectedFiles.length"></span>&nbsp;files
              </div>
              <button class="btn btn-primary btn-sm gap-1" @click="handleExtract()"
                :disabled="!currentFilename || selectedFiles.length === 0 || loading">
                <span class="loading loading-spinner loading-xs" x-show="loading" x-cloak></span>
                <i class="fas fa-bolt text-xs" x-show="!loading"></i> Extract
              </button>
            </div>
          </div>
        </div>

        <!-- CHAT TAB -->
        <div x-show="currentTab === 'chat'" x-cloak class="flex flex-col flex-1 gap-2">
          <select class="select select-bordered select-sm sm:hidden w-full" x-model="selectedModel">
            <template x-for="m in enabledModels()" :key="m.id">
              <option :value="m.id" x-text="m.name"></option>
            </template>
          </select>

          <div id="chat-messages" class="flex-1 overflow-y-auto scrollbar-thin space-y-1 min-h-[300px] max-h-[calc(100vh-260px)]">
            <!-- Empty state -->
            <div x-show="chatMessages.length === 0" class="flex flex-col items-center justify-center h-full text-base-content/30 gap-3 py-12">
              <i class="fas fa-robot text-5xl"></i>
              <p class="text-sm">Chat with AI about your code</p>
              <p class="text-xs opacity-60">Select files & extract first, then ask questions</p>
              <div class="flex flex-wrap gap-2 justify-center mt-2" x-show="selectedFiles.length > 0">
                <button class="btn btn-xs btn-outline" @click="runQuickAction('explain')">Explain</button>
                <button class="btn btn-xs btn-outline" @click="runQuickAction('bugs')">Find Bugs</button>
                <button class="btn btn-xs btn-outline" @click="runQuickAction('improve')">Improve</button>
              </div>
            </div>

            <template x-for="(msg, i) in chatMessages" :key="i">
              <div class="fade-in" :class="msg.role === 'user' ? 'chat chat-end' : 'chat chat-start'">
                <div class="chat-header text-[10px] opacity-50 mb-0.5">
                  <span x-text="msg.role === 'user' ? 'You' : (msg.model || 'AI')"></span>
                  <span x-show="msg.cached" class="badge badge-xs badge-ghost ml-1">cached</span>
                </div>
                <div class="chat-bubble max-w-[85%] text-sm"
                  :class="msg.role === 'user' ? 'chat-bubble-primary' : (msg.isError ? 'chat-bubble-error' : '')">
                  <div x-show="msg.role === 'user'" x-text="msg.content"></div>
                  <div x-show="msg.role !== 'user'" class="chat-md" x-html="renderMarkdown(msg.content)"></div>
                </div>
                <div class="chat-footer text-[10px] opacity-30" x-show="msg.usage">
                  <span x-text="msg.usage ? msg.usage.total_tokens + ' tokens' : ''"></span>
                </div>
              </div>
            </template>

            <div x-show="chatLoading" class="chat chat-start fade-in" x-cloak>
              <div class="chat-bubble"><span class="loading loading-dots loading-sm"></span></div>
            </div>
          </div>

          <div class="flex gap-2 items-end">
            <textarea class="textarea textarea-bordered flex-1 min-h-[42px] max-h-28 text-sm resize-none"
              x-model="chatInput"
              @keydown.ctrl.enter.prevent="sendMessage()"
              @keydown.meta.enter.prevent="sendMessage()"
              placeholder="Ask about your code... (Ctrl+Enter to send)"
              rows="1"
              @input="$el.style.height='auto';$el.style.height=Math.min($el.scrollHeight,112)+'px'"></textarea>
            <button class="btn btn-primary btn-sm" @click="sendMessage()" :disabled="chatLoading || !chatInput.trim()">
              <i class="fas fa-paper-plane text-xs"></i>
            </button>
            <button class="btn btn-ghost btn-sm" @click="clearChat()" x-show="chatMessages.length > 0" x-cloak>
              <i class="fas fa-trash text-xs"></i>
            </button>
          </div>
        </div>

        <!-- OUTPUT TAB -->
        <div x-show="currentTab === 'output'" x-cloak class="flex flex-col flex-1 gap-2">
          <div class="flex gap-2 items-center flex-wrap">
            <div class="badge badge-ghost badge-sm font-mono" x-show="mergedContent" x-cloak>
              <span x-text="formatTokens(VZ.utils.estimateTokens(mergedContent))"></span>&nbsp;tokens
            </div>
            <div class="badge badge-ghost badge-sm" x-show="mergedContent" x-cloak>
              <span x-text="VZ.utils.formatFileSize(new Blob([mergedContent]).size)"></span>
            </div>
            <div class="flex-1"></div>
            <button class="btn btn-sm btn-outline gap-1" @click="copyOutput()" :disabled="!mergedContent">
              <i class="fas fa-copy text-xs"></i> Copy
            </button>
            <button class="btn btn-sm btn-outline gap-1" @click="downloadOutput()" :disabled="!mergedContent">
              <i class="fas fa-download text-xs"></i> Download
            </button>
          </div>
          <textarea class="textarea textarea-bordered flex-1 font-mono text-xs leading-relaxed min-h-[400px] resize-y"
            x-model="mergedContent" readonly
            placeholder="Extracted content will appear here..."></textarea>
        </div>
      </main>
    </div>

    <!-- SIDEBAR -->
    <div class="drawer-side z-40">
      <label for="sidebar" aria-label="close sidebar" class="drawer-overlay"></label>
      <aside class="w-80 min-h-full bg-base-200 flex flex-col border-r border-base-300">

        <div class="p-3 border-b border-base-300 space-y-3">
          <div class="flex items-center gap-2">
            <span class="text-lg font-bold tracking-tight"><span class="text-primary">Vibz</span>code</span>
            <div class="flex-1"></div>
            <label for="sidebar" class="btn btn-ghost btn-xs btn-circle lg:hidden"><i class="fas fa-times"></i></label>
          </div>

          <!-- Upload tabs -->
          <div role="tablist" class="tabs tabs-boxed tabs-xs bg-base-300">
            <a role="tab" class="tab gap-1" :class="{'tab-active': uploadTab === 'github'}" @click="uploadTab = 'github'">
              <i class="fab fa-github text-xs"></i> <span class="text-xs">GitHub</span>
            </a>
            <a role="tab" class="tab gap-1" :class="{'tab-active': uploadTab === 'url'}" @click="uploadTab = 'url'">
              <i class="fas fa-link text-xs"></i> <span class="text-xs">URL</span>
            </a>
            <a role="tab" class="tab gap-1" :class="{'tab-active': uploadTab === 'file'}" @click="uploadTab = 'file'">
              <i class="fas fa-file-zipper text-xs"></i> <span class="text-xs">ZIP</span>
            </a>
          </div>

          <!-- GitHub -->
          <div x-show="uploadTab === 'github'" class="space-y-2">
            <!-- Auth Status -->
            <div x-show="!githubAuth.authenticated" class="alert alert-sm bg-base-300 border-0 p-2">
              <i class="fas fa-info-circle text-xs"></i>
              <span class="text-xs">Sign in to access private repos</span>
            </div>

            <div x-show="githubAuth.authenticated" class="flex items-center gap-2 p-2 bg-success/10 rounded border border-success/20">
              <img x-show="githubAuth.user?.avatar_url" :src="githubAuth.user?.avatar_url" class="w-5 h-5 rounded-full" />
              <div class="flex-1 min-w-0">
                <div class="text-xs font-medium truncate" x-text="githubAuth.user?.login"></div>
              </div>
              <button @click="logout()" class="btn btn-ghost btn-xs">
                <i class="fas fa-sign-out-alt text-xs"></i>
              </button>
            </div>

            <!-- Connect Button -->
            <button x-show="!githubAuth.authenticated" @click="loginWithGitHub()" class="btn btn-sm btn-outline w-full gap-2">
              <i class="fab fa-github"></i> Connect GitHub
            </button>

            <!-- Browse Repos -->
            <div x-show="githubAuth.authenticated" class="space-y-2">
              <button @click="fetchUserRepos()" :disabled="loadingRepos" class="btn btn-sm btn-outline w-full gap-2">
                <span class="loading loading-spinner loading-xs" x-show="loadingRepos" x-cloak></span>
                <i class="fas fa-folder-tree text-xs" x-show="!loadingRepos"></i>
                <span x-text="userRepos.length > 0 ? 'Refresh Repos' : 'Browse Repos'"></span>
              </button>

              <!-- Repos List -->
              <div x-show="userRepos.length > 0" class="max-h-48 overflow-y-auto border border-base-300 rounded-lg bg-base-100">
                <template x-for="repo in userRepos" :key="repo.id">
                  <div @click="selectRepo(repo)" class="p-2 hover:bg-base-200 cursor-pointer border-b border-base-300 last:border-0">
                    <div class="flex items-start gap-2">
                      <i class="fas fa-lock text-xs text-warning mt-0.5" x-show="repo.private"></i>
                      <i class="fas fa-book text-xs text-base-content/40 mt-0.5" x-show="!repo.private"></i>
                      <div class="flex-1 min-w-0">
                        <div class="text-xs font-medium truncate" x-text="repo.full_name"></div>
                        <div class="text-[10px] text-base-content/50 truncate" x-text="repo.description || 'No description'"></div>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>

            <!-- Manual URL -->
            <div class="divider text-xs my-1">Or enter URL</div>
            <input type="text" class="input input-bordered input-sm w-full"
              x-model="githubUrl" placeholder="https://github.com/user/repo"
              @keydown.enter="uploadFromGitHub()">
            <div class="flex gap-2">
              <input type="text" class="input input-bordered input-sm w-20"
                x-model="githubBranch" placeholder="main">
              <button class="btn btn-primary btn-sm flex-1 gap-1" @click="uploadFromGitHub()" :disabled="!githubUrl || loading">
                <span class="loading loading-spinner loading-xs" x-show="loading" x-cloak></span>
                <i class="fas fa-cloud-arrow-down text-xs" x-show="!loading"></i> Clone
              </button>
            </div>
          </div>

          <!-- URL -->
          <div x-show="uploadTab === 'url'" class="flex gap-2" x-cloak>
            <input type="text" class="input input-bordered input-sm flex-1"
              x-model="uploadUrl" placeholder="https://example.com/file.zip"
              @keydown.enter="uploadFromUrl()">
            <button class="btn btn-primary btn-sm" @click="uploadFromUrl()" :disabled="!uploadUrl || loading">
              <i class="fas fa-download text-xs"></i>
            </button>
          </div>

          <!-- File upload -->
          <div x-show="uploadTab === 'file'" x-cloak>
            <div class="border-2 border-dashed rounded-lg p-4 text-center transition-all"
              :class="isDragging ? 'border-primary bg-primary/10' : 'border-base-300'"
              @dragover.prevent="isDragging = true"
              @dragleave.prevent="isDragging = false"
              @drop.prevent="handleFileDrop($event)">
              <i class="fas fa-cloud-arrow-up text-xl text-base-content/30 mb-1"></i>
              <p class="text-xs text-base-content/40 mb-2">Drop ZIP here</p>
              <input type="file" class="file-input file-input-bordered file-input-xs w-full"
                accept=".zip" @change="uploadZipFile($event.target.files[0])">
            </div>
          </div>
        </div>

        <!-- Previous uploads -->
        <div x-show="uploadedFiles.length > 0" x-cloak class="border-b border-base-300">
          <details class="collapse collapse-arrow">
            <summary class="collapse-title text-xs font-medium py-2 px-3 min-h-0">
              Projects <span class="badge badge-xs ml-1" x-text="uploadedFiles.length"></span>
            </summary>
            <div class="collapse-content px-1 pb-2">
              <template x-for="f in uploadedFiles" :key="f">
                <div class="flex items-center gap-1 py-0.5 hover:bg-base-300 rounded px-2 group text-xs cursor-pointer"
                  @click="reopenProject(f)">
                  <i class="fas fa-archive text-[10px] text-base-content/40"></i>
                  <span class="flex-1 truncate" x-text="f"></span>
                  <button class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 min-h-0 h-5 px-1"
                    @click.stop="deleteUpload(f)">
                    <i class="fas fa-trash text-[10px] text-error"></i>
                  </button>
                </div>
              </template>
            </div>
          </details>
        </div>

        <!-- File Tree -->
        <div class="flex-1 overflow-hidden flex flex-col" x-show="fileStructure" x-cloak>
          <div class="p-2 space-y-2 border-b border-base-300">
            <div class="relative">
              <i class="fas fa-search text-[10px] absolute left-2.5 top-1/2 -translate-y-1/2 text-base-content/30"></i>
              <input id="file-search" type="text" class="input input-bordered input-xs w-full pl-7"
                x-model="fileSearchQuery" placeholder="Search files (Ctrl+K)">
            </div>
            <div class="flex gap-1">
              <button class="btn btn-ghost btn-xs flex-1" @click="selectAllFiles()">All</button>
              <button class="btn btn-ghost btn-xs flex-1" @click="deselectAllFiles()">None</button>
              <button class="btn btn-ghost btn-xs flex-1 gap-1" @click="selectImportantFiles()">
                <i class="fas fa-star text-warning text-[8px]"></i>Key
              </button>
            </div>
            <div class="flex items-center justify-between text-[10px] text-base-content/40 px-1">
              <span x-text="getFileCount() + ' files total'"></span>
              <button class="badge badge-sm gap-1 cursor-pointer hover:badge-primary transition-colors"
                :class="selectedFiles.length > 0 ? 'badge-outline badge-primary' : 'badge-ghost'"
                @click="if(selectedFiles.length) showSelectedModal = true"
                x-text="selectedFiles.length + ' selected'"></button>
            </div>
          </div>

          <div class="flex-1 overflow-y-auto scrollbar-thin p-2" x-html="renderTree(fileStructure)"></div>

          <div class="p-2 border-t border-base-300 space-y-1.5">
            <div class="flex gap-1">
              <input type="text" class="input input-bordered input-xs flex-1" x-model="groupName" placeholder="Save selection as...">
              <button class="btn btn-primary btn-xs" @click="saveFileGroup()" :disabled="!groupName || selectedFiles.length === 0">
                <i class="fas fa-save text-[10px]"></i>
              </button>
            </div>
            <template x-for="g in fileGroups" :key="g.name">
              <div class="flex items-center gap-1 text-xs">
                <button class="btn btn-ghost btn-xs flex-1 justify-start gap-1 min-h-0 h-6" @click="loadFileGroup(g)">
                  <i class="fas fa-layer-group text-[10px] text-primary"></i>
                  <span x-text="g.name" class="truncate"></span>
                  <span class="badge badge-xs" x-text="g.files.length"></span>
                </button>
                <button class="btn btn-ghost btn-xs min-h-0 h-5 px-1" @click="deleteFileGroup(g.name)">
                  <i class="fas fa-times text-[10px]"></i>
                </button>
              </div>
            </template>
          </div>
        </div>

        <!-- Empty state -->
        <div class="flex-1 flex flex-col items-center justify-center text-base-content/20 p-8 gap-3" x-show="!fileStructure">
          <i class="fas fa-folder-open text-5xl"></i>
          <p class="text-sm text-center">Load a project to start</p>
          <p class="text-xs text-center opacity-60">Clone from GitHub, upload ZIP, or paste URL</p>
        </div>
      </aside>
    </div>
  </div>

  <!-- FILE PREVIEW MODAL -->
  <dialog id="preview-modal" class="modal" :class="{'modal-open': showPreview}">
    <div class="modal-box w-11/12 max-w-4xl max-h-[85vh] flex flex-col p-4">
      <div class="flex items-center gap-2 mb-3">
        <i class="fas fa-file-code text-primary text-sm"></i>
        <h3 class="font-mono text-sm flex-1 truncate" x-text="previewPath"></h3>
        <button class="btn btn-sm gap-1"
          :class="isFileSelected(previewPath) ? 'btn-error' : 'btn-primary'"
          @click="toggleFile(previewPath)">
          <i class="fas text-xs" :class="isFileSelected(previewPath) ? 'fa-minus' : 'fa-plus'"></i>
          <span x-text="isFileSelected(previewPath) ? 'Remove' : 'Add'"></span>
        </button>
        <button class="btn btn-ghost btn-sm btn-circle" @click="showPreview = false">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="flex-1 overflow-auto bg-base-300 rounded-lg">
        <pre class="p-3 m-0"><code id="preview-code" class="text-xs !bg-transparent" :class="'language-' + VZ.utils.getLanguage(previewPath || '')"></code></pre>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button @click="showPreview = false">close</button></form>
  </dialog>

  <!-- SELECTED FILES MODAL -->
  <dialog class="modal" :class="{'modal-open': showSelectedModal}">
    <div class="modal-box w-11/12 max-w-xl max-h-[85vh] flex flex-col p-0">
      <div class="flex items-center gap-2 p-4 border-b border-base-300">
        <i class="fas fa-check-double text-primary"></i>
        <h3 class="font-bold flex-1">Selected Files</h3>
        <span class="badge badge-primary badge-sm" x-text="selectedFiles.length"></span>
        <button class="btn btn-ghost btn-sm btn-circle" @click="showSelectedModal = false">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="flex-1 overflow-y-auto scrollbar-thin p-2" x-show="selectedFiles.length > 0">
        <template x-for="(fp, idx) in selectedFiles" :key="fp">
          <div class="flex items-center gap-2 py-1.5 px-2 hover:bg-base-200 rounded-lg group fade-in">
            <i :class="VZ.utils.getFileIcon(fp)" class="text-xs w-4 text-center shrink-0"></i>
            <span class="text-sm flex-1 truncate font-mono" x-text="fp"></span>
            <i class="fas fa-star text-warning text-[10px] shrink-0"
              x-show="importantFiles.includes(fp)"></i>
            <button class="btn btn-ghost btn-xs min-h-0 h-6 px-1.5 opacity-0 group-hover:opacity-100 tooltip tooltip-left"
              data-tip="Preview"
              @click="previewFile(fp)">
              <i class="fas fa-code text-xs text-info"></i>
            </button>
            <button class="btn btn-ghost btn-xs min-h-0 h-6 px-1.5 opacity-0 group-hover:opacity-100 tooltip tooltip-left"
              data-tip="Remove"
              @click="toggleFile(fp)">
              <i class="fas fa-xmark text-xs text-error"></i>
            </button>
          </div>
        </template>
      </div>
      <div class="flex items-center justify-center py-8 text-base-content/30" x-show="selectedFiles.length === 0">
        <p class="text-sm">No files selected</p>
      </div>
      <div class="p-3 border-t border-base-300 flex gap-2">
        <button class="btn btn-ghost btn-sm flex-1 gap-1" @click="deselectAllFiles()">
          <i class="fas fa-trash text-xs"></i> Clear All
        </button>
        <button class="btn btn-primary btn-sm flex-1 gap-1" @click="showSelectedModal = false; handleExtract()"
          :disabled="selectedFiles.length === 0">
          <i class="fas fa-bolt text-xs"></i> Extract
        </button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button @click="showSelectedModal = false">close</button></form>
  </dialog>

  <!-- SETTINGS MODAL -->
  <dialog class="modal" :class="{'modal-open': showSettings}">
    <div class="modal-box w-11/12 max-w-2xl max-h-[85vh] p-0">
      <div class="flex items-center gap-2 p-4 border-b border-base-300">
        <i class="fas fa-cog text-primary"></i>
        <h3 class="font-bold text-lg flex-1">Settings</h3>
        <button class="btn btn-ghost btn-sm btn-circle" @click="showSettings = false">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div role="tablist" class="tabs tabs-bordered px-4 pt-2">
        <input type="radio" name="stabs" role="tab" class="tab" aria-label="General" checked>
        <div role="tabpanel" class="tab-content p-4 space-y-4">
          <div class="form-control">
            <label class="label py-1"><span class="label-text text-sm">Max Upload Size (MB)</span></label>
            <input type="number" class="input input-bordered input-sm w-32" x-model.number="config.maxFileSizeMB">
          </div>
          <div class="form-control">
            <label class="label py-1"><span class="label-text text-sm">Default Model</span></label>
            <select class="select select-bordered select-sm" x-model="config.defaultModel">
              <template x-for="m in models" :key="m.id">
                <option :value="m.id" x-text="m.name"></option>
              </template>
            </select>
          </div>
          <label class="label cursor-pointer justify-start gap-3 py-1">
            <input type="checkbox" class="toggle toggle-primary toggle-sm" x-model="config.enableCache">
            <span class="label-text text-sm">Enable Prompt Caching</span>
          </label>
          <label class="label cursor-pointer justify-start gap-3 py-1">
            <input type="checkbox" class="toggle toggle-primary toggle-sm" x-model="config.autoSelectImportant">
            <span class="label-text text-sm">Auto-select important files</span>
          </label>
          <button class="btn btn-primary btn-sm" @click="saveConfig()">
            <i class="fas fa-save text-xs"></i> Save
          </button>
        </div>

        <input type="radio" name="stabs" role="tab" class="tab" aria-label="Models">
        <div role="tabpanel" class="tab-content p-4 space-y-3">
          <template x-for="m in models" :key="m.id">
            <div class="flex items-center gap-2 p-2 bg-base-200 rounded-lg">
              <input type="checkbox" class="toggle toggle-xs toggle-primary"
                :checked="m.enabled" @change="toggleModelEnabled(m.id)">
              <div class="flex-1 min-w-0">
                <div class="text-sm font-medium truncate" x-text="m.name"></div>
                <div class="text-[10px] opacity-40 truncate" x-text="m.id"></div>
              </div>
              <span class="badge badge-ghost badge-xs whitespace-nowrap" x-text="m.provider"></span>
              <button class="btn btn-ghost btn-xs text-error" @click="removeModel(m.id)">
                <i class="fas fa-trash text-[10px]"></i>
              </button>
            </div>
          </template>

          <div class="divider text-xs my-2">Add Model</div>
          <input type="text" class="input input-bordered input-sm w-full"
            x-model="newModelId" placeholder="Model ID (e.g. openai/gpt-4o)">
          <div class="flex gap-2">
            <input type="text" class="input input-bordered input-sm flex-1"
              x-model="newModelName" placeholder="Display Name">
            <input type="text" class="input input-bordered input-sm w-28"
              x-model="newModelProvider" placeholder="Provider">
          </div>
          <button class="btn btn-primary btn-sm w-full gap-1" @click="addModel()" :disabled="!newModelId || !newModelName">
            <i class="fas fa-plus text-xs"></i> Add Model
          </button>
        </div>

        <input type="radio" name="stabs" role="tab" class="tab" aria-label="API">
        <div role="tabpanel" class="tab-content p-4 space-y-4">
          <div class="form-control">
            <label class="label py-1"><span class="label-text text-sm">OpenRouter API Key</span></label>
            <input type="password" class="input input-bordered input-sm"
              :value="envConfig.OPENROUTER_API_KEY || ''"
              @change="updateEnvConfig('OPENROUTER_API_KEY', $event.target.value)"
              placeholder="sk-or-v1-...">
            <label class="label py-0.5"><span class="label-text-alt text-[10px] opacity-50">Get key from openrouter.ai</span></label>
          </div>
          <div class="form-control">
            <label class="label py-1"><span class="label-text text-sm">Max Upload Size (MB)</span></label>
            <input type="number" class="input input-bordered input-sm w-32"
              :value="envConfig.MAX_FILE_SIZE_MB || 50"
              @change="updateEnvConfig('MAX_FILE_SIZE_MB', $event.target.value)">
          </div>
          <div class="form-control">
            <label class="label py-1"><span class="label-text text-sm">Default Model</span></label>
            <input type="text" class="input input-bordered input-sm"
              :value="envConfig.DEFAULT_AI_MODEL || ''"
              @change="updateEnvConfig('DEFAULT_AI_MODEL', $event.target.value)"
              placeholder="openai/gpt-5.1-codex-mini">
          </div>
        </div>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button @click="showSettings = false">close</button></form>
  </dialog>

  <!-- NOTIFICATIONS -->
  <div class="toast toast-end toast-bottom z-50 mb-2">
    <template x-for="n in notifications" :key="n.id">
      <div class="alert shadow-lg fade-in py-2 px-4 min-h-0"
        :class="{
          'alert-success': n.type==='success',
          'alert-error': n.type==='error',
          'alert-warning': n.type==='warning',
          'alert-info': n.type==='info'
        }">
        <span class="text-sm" x-text="n.msg"></span>
      </div>
    </template>
  </div>

  <!-- LOADING OVERLAY -->
  <div x-show="loading" x-cloak
    class="fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-50"
    x-transition.opacity>
    <div class="bg-base-200 rounded-2xl p-8 shadow-2xl flex flex-col items-center gap-3">
      <span class="loading loading-spinner loading-lg text-primary"></span>
      <span class="text-sm text-base-content/70">Processing...</span>
    </div>
  </div>

</body>
</html>
